<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title> Designing website for helping people learning sign languages with 3D model </title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        
        body {
            margin: 0;
            background: #230181;
            color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            width: 90vw;
            max-width: 900px;
            text-align: center;
        }
        
        h1 {
            margin-bottom: 6px;
            font-size: 1.4rem;
        }
        
        .hint {
            font-size: 0.85rem;
            opacity: 0.75;
            margin-bottom: 10px;
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 900px;
            aspect-ratio: 4 / 3;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            background: #000;
        }
        
        video,
        canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #status {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        #gesture {
            margin-top: 6px;
            font-size: 1.05rem;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Hand by emmy AI ‚úã (fart so loud)</h1>
        <div class="hint">
            ‡∏¢‡∏Å‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏ó‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≥‡∏°‡∏∑‡∏≠ / ‡πÅ‡∏ö‡∏°‡∏∑‡∏≠ / ‡∏ä‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á / ‡∏ä‡∏π 1‚Äì5 ‡∏ô‡∏¥‡πâ‡∏ß
        </div>

        <div class="video-wrapper">
            <video id="video" playsinline></video>
            <canvas id="output"></canvas>
        </div>

        <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á...</div>
        <div id="gesture">‡∏ó‡πà‡∏≤‡∏°‡∏∑‡∏≠: -</div>
    </div>

    <!-- MediaPipe CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        const videoElement = document.getElementById("video");
        const canvasElement = document.getElementById("output");
        const canvasCtx = canvasElement.getContext("2d");
        const statusEl = document.getElementById("status");
        const gestureEl = document.getElementById("gesture");

        // index ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á
        const FINGER_TIPS = [4, 8, 12, 16, 20]; // thumb, index, middle, ring, pinky
        const FINGER_PIPS = [2, 6, 10, 14, 18];

        let canvasInitialized = false;
        let processing = false; // ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏ü‡∏£‡∏°‡∏ã‡πâ‡∏≠‡∏ô

        function getFingerStates(landmarks, handednessLabel) {
            const fingers = {
                thumb: false,
                index: false,
                middle: false,
                ring: false,
                pinky: false,
            };

            if (!landmarks || landmarks.length < 21) return fingers;

            // ‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á
            const thumbTip = landmarks[FINGER_TIPS[0]];
            const thumbMcp = landmarks[FINGER_PIPS[0]];

            if (thumbTip && thumbMcp) {
                if (handednessLabel === "Right") {
                    if (thumbTip.x > thumbMcp.x) fingers.thumb = true;
                } else {
                    if (thumbTip.x < thumbMcp.x) fingers.thumb = true;
                }
            }

            // ‡∏ô‡∏¥‡πâ‡∏ß‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
            const names = ["index", "middle", "ring", "pinky"];
            for (let i = 1; i < FINGER_TIPS.length; i++) {
                const tip = landmarks[FINGER_TIPS[i]];
                const pip = landmarks[FINGER_PIPS[i]];
                if (!tip || !pip) continue;
                if (tip.y < pip.y) {
                    fingers[names[i - 1]] = true;
                }
            }

            return fingers;
        }

        function classifyGesture(fingers) {
            const upList = [];
            for (const [name, state] of Object.entries(fingers)) {
                if (state) upList.push(name);
            }
            const count = upList.length;

            if (count === 0) return "‡∏Å‡∏≥‡∏°‡∏∑‡∏≠ (0 ‡∏ô‡∏¥‡πâ‡∏ß)";
            if (count === 5) return "‡πÅ‡∏ö‡∏°‡∏∑‡∏≠ (5 ‡∏ô‡∏¥‡πâ‡∏ß)";

            if (
                fingers.thumb &&
                !fingers.index &&
                !fingers.middle &&
                !fingers.ring &&
                !fingers.pinky
            ) {
                return "‡∏ä‡∏π‡∏ô‡∏¥‡πâ‡∏ß‡πÇ‡∏õ‡πâ‡∏á (‡πÑ‡∏•‡∏Å‡πå üëç)";
            }

            if (
                fingers.index &&
                !fingers.thumb &&
                !fingers.middle &&
                !fingers.ring &&
                !fingers.pinky
            ) {
                return "‡∏ä‡∏π 1 ‡∏ô‡∏¥‡πâ‡∏ß (‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏µ‡πâ)";
            }

            if (
                fingers.index &&
                fingers.middle &&
                !fingers.ring &&
                !fingers.pinky
            ) {
                return "‡∏ä‡∏π 2 ‡∏ô‡∏¥‡πâ‡∏ß (‡∏ó‡πà‡∏≤ V ‚úåÔ∏è)";
            }

            if (!fingers.thumb &&
                fingers.index &&
                fingers.middle &&
                fingers.ring &&
                !fingers.pinky
            ) {
                return "‡∏ä‡∏π 3 ‡∏ô‡∏¥‡πâ‡∏ß";
            }

            if (count === 4 && !fingers.thumb) return "‡∏ä‡∏π 4 ‡∏ô‡∏¥‡πâ‡∏ß";
            if (count === 4 && !fingers.pinky) return "4 ‡∏ô‡∏¥‡πâ‡∏ß (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Å‡πâ‡∏≠‡∏¢)";

            return `‡∏¢‡∏Å ${count} ‡∏ô‡∏¥‡πâ‡∏ß`;
        }

        function onResults(results) {
            try {
                // ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                if (!canvasInitialized && videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    canvasInitialized = true;
                }

                if (!canvasInitialized) {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£
                    processing = false;
                    return;
                }
        

                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

                // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
                if (results.image) {
                    canvasCtx.drawImage(
                        results.image,
                        0,
                        0,
                        canvasElement.width,
                        canvasElement.height
                    );
                }

                let gestureText = "‡∏ó‡πà‡∏≤‡∏°‡∏∑‡∏≠: -";

                const hasHands =
                    Array.isArray(results.multiHandLandmarks) &&
                    results.multiHandLandmarks.length > 0;

                if (hasHands) {
                    statusEl.textContent =
                        "‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏°‡∏∑‡∏≠ " + results.multiHandLandmarks.length + " ‡∏Ç‡πâ‡∏≤‡∏á";

                    // ‡∏ß‡∏≤‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏°‡∏∑‡∏≠ (‡∏ñ‡πâ‡∏≤ function ‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á)
                    const canDraw =
                        typeof drawConnectors === "function" &&
                        typeof drawLandmarks === "function" &&
                        typeof HAND_CONNECTIONS !== "undefined";

                    if (canDraw) {
                        for (const lms of results.multiHandLandmarks) {
                            drawConnectors(canvasCtx, lms, HAND_CONNECTIONS, {
                                lineWidth: 3
                            });
                            drawLandmarks(canvasCtx, lms, {
                                radius: 3
                            });
                        }
                    }

                    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡πà‡∏≤‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏Ç‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• handedness)
                    let handed = "Unknown";
                    if (
                        Array.isArray(results.multiHandedness) &&
                        results.multiHandedness.length > 0 &&
                        results.multiHandedness[0].classification &&
                        results.multiHandedness[0].classification.length > 0 &&
                        typeof results.multiHandedness[0].classification[0].label === "string"
                    ) {
                        handed = results.multiHandedness[0].classification[0].label; // "Left" ‡∏´‡∏£‡∏∑‡∏≠ "Right"
                    }

                    const landmarks = results.multiHandLandmarks[0];
                    const fingers = getFingerStates(landmarks, handed);
                    const classified = classifyGesture(fingers);
                    gestureText = `‡∏ó‡πà‡∏≤‡∏°‡∏∑‡∏≠ (${handed}): ${classified}`;

                    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏†‡∏≤‡∏û
                    canvasCtx.fillStyle = "rgba(0, 0, 0, 0.6)";
                    canvasCtx.fillRect(10, 10, 340, 40);
                    canvasCtx.fillStyle = "#00ff99";
                    canvasCtx.font = "16px system-ui";
                    canvasCtx.fillText(classified, 18, 36);
                } else {
                    statusEl.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏°‡∏∑‡∏≠ ‡∏•‡∏≠‡∏á‡∏¢‡∏Å‡∏°‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏î‡∏π‡∏ô‡∏∞ üëã";
                }

                gestureEl.textContent = gestureText;

                canvasCtx.restore();
            } catch (e) {
                console.error("onResults error:", e);
                statusEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏î‡∏π console log";
            } finally {
                processing = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏ü‡∏£‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            }
        }

        const hands = new Hands({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            },
        });

        hands.setOptions({
            maxNumHands: 2, // ‡πÄ‡∏ö‡∏≤‡∏•‡∏á
            modelComplexity: 1, // 0 = ‡πÄ‡∏ö‡∏≤‡∏™‡∏∏‡∏î
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6,
        });
        
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async() => {
                // ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏ü‡∏£‡∏°‡∏ã‡πâ‡∏≠‡∏ô
                if (processing) return;
                processing = true;
                try {
                    await hands.send({
                        image: videoElement
                    });
                } catch (e) {
                    console.error("send error:", e);
                    processing = false;
                }
            },
            width: 480,
            height: 360,
        });

        camera
            .start()
            .then(() => {
                statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á...";
            })
            .catch((err) => {
                console.error(err);
                statusEl.textContent =
                    "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á";
            });
    </script>
</body>

</html>
